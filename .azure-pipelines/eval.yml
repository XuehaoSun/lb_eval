trigger:
  branches:
    include:
      - main
  paths:
    include:
      - .azure-pipelines
      - "**/*.json"
    exclude:
      - evaluation

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: CheckHardware
    jobs:
      - job: CheckHardware
        steps:
        - bash: |
            echo "##vso[task.setvariable variable=hardware;isOutput=true]$(sed -n '1p' eval.txt)"
            echo "##vso[task.setvariable variable=scripts;isOutput=true]$(sed -n '2p' eval.txt)"
          name: setVarFromJsonFileValue
        - bash: |
            echo "Hardware: $(hardware)"
            echo "Scripts: $(scripts)"
      - job:
        steps:
        - bash: |
            git clone https://github.com/XuehaoSun/lb_eval.git
            cd lb_eval
            echo "Waiting" > status.txt
            git remote set-url origin https://XuehaoSun:$(TOKEN)@github.com/XuehaoSun/lb_eval.git
            git add . && git commit -m "Update status" && git push

  - stage: Eval
    displayName: Evaluation
    variables:
      hardware: $[stageDependencies.CheckHardware.CheckHardware.outputs['setVarFromJsonFileValue.hardware']]
      scripts: $[stageDependencies.CheckHardware.CheckHardware.outputs['setVarFromJsonFileValue.scripts']]
    pool: $(hardware)
    dependsOn: [CheckHardware]
    jobs:
      - job: Eval
        steps:
          - template: template/model-template.yml
            parameters:
              scriptsPath: "$(scripts)"
